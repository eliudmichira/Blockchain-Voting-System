<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Decentralized Voting</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Particles.js -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <!-- Ethers.js (local) -->
    <script src="../js/lib/ethers.js"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https://via.placeholder.com https://cdn.pixabay.com; connect-src 'self' http://localhost:8000 https://api.example.com;">
    
    <!-- Using Unicode symbols instead of Font Awesome -->
    <style>
        /* Base styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        
        /* Particles.js styles */
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #f9fafb; /* Light mode background */
            overflow: hidden;
        }
        
        /* Dark mode particles background */
        .dark #particles-js {
            background-color: #111827; /* Dark mode background */
        }
        
        .particles-js-canvas-el {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: auto;
            cursor: pointer;
        }
        
        /* Particles fallback */
        #particles-fallback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            opacity: 0.5;
        }
        
        .dark #particles-fallback {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            opacity: 0.3;
        }
        
        /* Unicode icons */
        .icon-sun::before { content: "‚òÄÔ∏è"; }
        .icon-moon::before { content: "üåô"; }
        .icon-user::before { content: "üë§"; }
        .icon-users::before { content: "üë•"; }
        .icon-calendar::before { content: "üìÖ"; }
        .icon-chart::before { content: "üìä"; }
        .icon-settings::before { content: "‚öôÔ∏è"; }
        .icon-logout::before { content: "üö™"; }
        .icon-plus::before { content: "‚ûï"; }
        .icon-minus::before { content: "‚ûñ"; }
        .icon-check::before { content: "‚úÖ"; }
        .icon-x::before { content: "‚ùå"; }
        .icon-warning::before { content: "‚ö†Ô∏è"; }
        .icon-info::before { content: "‚ÑπÔ∏è"; }
        .icon-edit::before { content: "‚úèÔ∏è"; }
        .icon-delete::before { content: "üóëÔ∏è"; }
        .icon-save::before { content: "üíæ"; }
        .icon-refresh::before { content: "üîÑ"; }
        .icon-wallet::before { content: "ü¶ä"; }
        .icon-connect::before { content: "üîå"; }
        .icon-vote::before { content: "üó≥Ô∏è"; }
        .icon-disconnect::before { content: "üîå"; }
        .icon-link::before { content: "üîó"; }
        .icon-network-wired::before { content: "üì°"; }
        .icon-file-contract::before { content: "üìÑ"; }
        .icon-sync-alt::before { content: "üîÑ"; }
        .icon-list::before { content: "üóÇÔ∏è"; }
        .icon-times::before { content: "‚ùå"; }
        .icon-close::before { content: "‚úñ"; }
        .icon-exclamation-circle::before { content: "‚ö†Ô∏è"; }
        .icon-check-circle::before { content: "‚úÖ"; }
        .icon-loader::before { content: "‚è≥"; }
        
        /* Icon spacing */
        [class^="icon-"] {
            margin-right: 0.5rem;
            display: inline-block;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/admin-config.js" type="module"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                            950: '#042f2e'
                        },
                    },
                    fontFamily: {
                        sans: [
                            '-apple-system',
                            'BlinkMacSystemFont',
                            '"Segoe UI"',
                            'Roboto',
                            'Helvetica',
                            'Arial',
                            'sans-serif',
                            '"Apple Color Emoji"',
                            '"Segoe UI Emoji"',
                            '"Segoe UI Symbol"'
                        ],
                    }
                }
            }
        }
    </script>
    
    <!-- Fallback SVG icons in case Font Awesome fails to load -->
    <style>
        /* SVG icon fallbacks */
        .icon-fallback {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
        }
        
        /* Only show these if Font Awesome fails */
        .icon-fallback {
            display: none;
        }
        
        /* Custom styling for the application */
        .blockchain-background {
            background-image: linear-gradient(to bottom right, rgba(0, 0, 0, 0.02) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(0, 0, 0, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Dark mode adjustments */
        .dark .blockchain-background {
            background-image: linear-gradient(to bottom right, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        }
        
        /* Loader animation */
        .loader {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        // Apply saved or system-preferred theme on load
        if (localStorage.theme === "dark" || (!localStorage.theme && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }
    </script>
    <style>
        /* Using system fonts instead of Google Fonts */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .tab-content {
            display: none;
            transition: all 0.3s ease;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Debug panel styles */
        #debugPanel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 80%;
            max-width: 600px;
            height: 300px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            padding: 10px;
            z-index: 9999;
            border-top-left-radius: 8px;
            backdrop-filter: blur(10px);
        }

        #debugContent {
            height: 250px;
            overflow-y: auto;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <link href="/css/index.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="/js/contract-loader.js"></script>
    <script src="/js/contract-health.js"></script>
    <script src="/js/event-listener.js"></script>
    <script src="/js/network-detector.js"></script>
    <script src="/js/deployment-config.js"></script>
    <script src="/js/deployment-stats-capture.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- Particles background -->
    <div id="particles-js"></div>
    <div id="particles-fallback"></div>

    <!-- Main content -->
    <div class="relative z-10">
        <!-- Admin Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md">
            <div class="container mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <span class="icon-user-shield text-2xl"></span>
                        <h1 class="ml-2 text-xl font-bold text-gray-800 dark:text-white">Voting System Admin</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Theme Toggle Button -->
                        <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" 
                                onclick="toggleTheme()" 
                                data-tooltip-target="tooltip-toggle">
                            <span class="icon-sun text-yellow-500 dark:hidden"></span>
                            <span class="icon-moon text-blue-300 hidden dark:block"></span>
                        </button>
                        <div id="tooltip-toggle" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip">
                            Toggle Dark Mode
                        </div>
                        
                        <!-- Connect Button -->
                        <button id="connectButton" class="flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm">
                            <span class="icon-connect mr-2"></span><span>Connect</span>
                        </button>
                        
                        <!-- Logout Button -->
                        <button id="logoutButton" class="flex items-center px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm">
                            <span class="icon-logout mr-2"></span><span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Connection Status Card -->
            <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                    <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                        <i class="fas fa-link mr-2"></i>
                        Blockchain Connection
                    </h2>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <i class="fas fa-network-wired mr-2 text-primary-500 dark:text-primary-400"></i>
                                <p id="networkInfo" class="text-sm">Not connected to any network</p>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-file-contract mr-2 text-primary-500 dark:text-primary-400"></i>
                                <p id="contractInfo" class="text-sm">Contract not loaded</p>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                            <button id="connectButtonPanel"
                                class="flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm">
                                <span class="icon-connect"></span>
                                <span>Connect</span>
                            </button>
                            <button id="refreshDataButton"
                                class="flex-1 py-2 px-4 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors flex items-center justify-center">
                                <i class="fas fa-sync-alt mr-2"></i>
                                <span>Refresh Data</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="rounded-full bg-blue-100 dark:bg-blue-900/30 p-3 mr-4">
                            <i class="fas fa-users text-blue-500"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total Candidates</p>
                            <p id="totalCandidates" class="text-2xl font-bold">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="rounded-full bg-green-100 dark:bg-green-900/30 p-3 mr-4">
                            <i class="fas fa-vote-yea text-green-500"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total Votes</p>
                            <p id="totalVotes" class="text-2xl font-bold">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="rounded-full bg-purple-100 dark:bg-purple-900/30 p-3 mr-4">
                            <i class="fas fa-calendar-alt text-purple-500"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Voting Status</p>
                            <p id="votingStatus" class="text-2xl font-bold">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <div class="rounded-full bg-yellow-100 dark:bg-yellow-900/30 p-3 mr-4">
                            <i class="fas fa-clock text-yellow-500"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Time Remaining</p>
                            <p id="timeRemaining" class="text-2xl font-bold">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-8">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex flex-wrap" aria-label="Tabs">
                        <button id="tab-candidates"
                            class="tab-button text-primary-600 dark:text-primary-400 py-4 px-6 font-medium border-b-2 border-primary-500 dark:border-primary-400"
                            role="tab" aria-selected="true" aria-controls="content-candidates">
                            <i class="fas fa-users mr-2"></i>
                            Manage Candidates
                        </button>
                        <button id="tab-voting-dates"
                            class="tab-button text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 py-4 px-6 font-medium border-b-2 border-transparent"
                            role="tab" aria-selected="false" aria-controls="content-voting-dates">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            Voting Period
                        </button>
                        <button id="tab-results"
                            class="tab-button text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 py-4 px-6 font-medium border-b-2 border-transparent"
                            role="tab" aria-selected="false" aria-controls="content-results">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Results
                        </button>
                        <!-- Configuration Tab Button -->
                        <button id="tab-config"
                            class="tab-button text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 py-4 px-6 font-medium border-b-2 border-transparent"
                            role="tab" aria-selected="false" aria-controls="content-config">
                            <span class="icon-settings mr-2"></span>
                            Configuration
                        </button>
                        <!-- Contract Deployment Tab Button -->
                        <button id="tab-deployment"
                            class="tab-button text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 py-4 px-6 font-medium border-b-2 border-transparent"
                            role="tab" aria-selected="false" aria-controls="content-deployment">
                            <span class="icon-file-contract mr-2"></span>
                            Deploy Contract
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="space-y-8">
                <!-- Candidate Management Tab -->
                <div id="content-candidates" class="tab-content active fade-in" role="tabpanel"
                    aria-labelledby="tab-candidates">
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <!-- Add Candidate -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div
                                class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    Add New Candidate
                                </h2>
                            </div>
                            <div class="p-6">
                                <div id="candidateFeedbackContainer"
                                    class="mb-4 p-4 border rounded-md hidden">
                                    <div class="flex">
                                        <div id="candidateFeedbackIcon" class="flex-shrink-0 mr-3"></div>
                                        <div>
                                            <h3 id="candidateFeedbackTitle" class="text-sm font-medium"></h3>
                                            <div class="mt-1 text-sm" id="candidateFeedback"></div>
                                        </div>
                                    </div>
                                </div>

                                <form id="addCandidateForm" class="space-y-4" data-admin-only="true">
                                    <div>
                                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Candidate Name
                                        </label>
                                        <input type="text" id="name" name="name"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            placeholder="Enter candidate name" autocomplete="name">
                                    </div>
                                    <div>
                                        <label for="party" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Political Party
                                        </label>
                                        <input type="text" id="party" name="party"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            placeholder="Enter political party" autocomplete="organization">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Candidate Image
                                        </label>
                                        <div id="imageDropArea" class="mt-1 relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 flex flex-col items-center justify-center hover:border-primary-500 dark:hover:border-primary-500 transition-colors cursor-pointer">
                                            <div id="imagePreviewContainer" class="hidden mb-3 relative">
                                                <img id="imagePreview" class="h-24 w-24 object-cover rounded-lg shadow-sm" src="" alt="Candidate preview">
                                                <button type="button" id="removeImageBtn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors">
                                                    ‚úï
                                                </button>
                                            </div>
                                            <div id="uploadIconContainer">
                                                <span class="mb-2 block text-3xl text-gray-400 dark:text-gray-500">üì∑</span>
                                                <span class="text-gray-600 dark:text-gray-400">Drag image here or click to upload</span>
                                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">PNG, JPG, or JPEG up to 2MB</p>
                                            </div>
                                            <input type="file" id="imageUpload" name="imageUpload" accept="image/png, image/jpeg, image/jpg" class="sr-only">
                                            <input type="hidden" id="imageUrl" name="imageUrl">
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <button type="submit" id="addCandidateButton"
                                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-primary-700 dark:hover:bg-primary-800">
                                            <span class="icon-plus-circle mr-2"></span>Add Candidate
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </section>

                        <!-- Candidate List -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div
                                class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                        <i class="fas fa-list mr-2"></i>
                                        Candidate List
                                    </h2>
                                    <button id="refreshCandidatesButton"
                                        class="py-1 px-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-md transition-colors text-sm flex items-center">
                                        <i class="fas fa-sync-alt mr-1"></i>
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                ID
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Candidate
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Party
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Votes
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Edit
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="candidateList">
                                        <tr>
                                            <td colspan="4" class="px-4 py-6 text-center">
                                                <p class="text-gray-500 dark:text-gray-400">Connect your wallet to view candidates</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Voting Period Tab -->
                <div id="content-voting-dates" class="tab-content" role="tabpanel" aria-labelledby="tab-voting-dates">
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <!-- Current Voting Period -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div
                                class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <i class="fas fa-calendar-check mr-2"></i>
                                    Current Voting Period
                                </h2>
                            </div>
                            <div class="p-6">
                                <div class="flex items-center mb-4">
                                    <div id="datesLoadingIndicator" class="mr-2">
                                        <div class="loader border-gray-500 dark:border-gray-400"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p id="currentDatesDisplay" class="text-gray-700 dark:text-gray-300">
                                            Connect your wallet to view voting period
                                        </p>
                                    </div>
                                    <span id="votingStatusBadge"
                                        class="hidden px-2 py-1 text-xs font-medium rounded-full">
                                        Status
                                    </span>
                                </div>

                                <div id="electionProgressContainer" class="mt-8 hidden">
                                    <div class="flex justify-between items-center mb-2">
                                        <span id="electionStartLabel" class="text-xs text-gray-500 dark:text-gray-400"></span>
                                        <span id="electionEndLabel" class="text-xs text-gray-500 dark:text-gray-400"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                        <div id="electionProgress" class="bg-primary-500 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p id="electionTimeRemaining" class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400"></p>
                                </div>

                                <div class="mt-6 flex">
                                    <button id="updateDatesButton"
                                        class="flex-1 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-700 dark:hover:bg-blue-800">
                                        <i class="fas fa-edit mr-2"></i>Update Existing Dates
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Set Voting Period -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div
                                class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <i class="fas fa-calendar-plus mr-2"></i>
                                    Set Voting Period
                                </h2>
                            </div>
                            <div class="p-6">
                                <div id="datesFeedbackContainer"
                                    class="mb-4 p-4 border rounded-md hidden">
                                    <div class="flex">
                                        <div id="datesFeedbackIcon" class="flex-shrink-0 mr-3"></div>
                                        <div>
                                            <h3 id="datesFeedbackTitle" class="text-sm font-medium"></h3>
                                            <div class="mt-1 text-sm" id="datesFeedback"></div>
                                        </div>
                                    </div>
                                </div>

                                <form id="setDatesForm" class="space-y-4" data-admin-only="true">
                                    <div>
                                        <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Voting Start Date & Time
                                        </label>
                                        <input type="datetime-local" id="startDate" name="startDate"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            autocomplete="off">
                                    </div>
                                    <div>
                                        <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Voting End Date & Time
                                        </label>
                                        <input type="datetime-local" id="endDate" name="endDate"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            autocomplete="off">
                                    </div>
                                    <div class="pt-2">
                                        <button type="submit" id="setDatesButton"
                                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-primary-700 dark:hover:bg-primary-800">
                                            <span class="icon-save mr-2"></span>Set New Period
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="content-results" class="tab-content" role="tabpanel" aria-labelledby="tab-results">
                    <div class="space-y-8">
                        <!-- Loading Indicator -->
                        <div id="resultsLoading" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden p-8 text-center">
                            <div id="resultsLoadingIndicator" class="inline-block mb-4">
                                <div class="loader border-gray-500 dark:border-gray-400"></div>
                            </div>
                            <p id="resultsLoadingText" class="text-gray-700 dark:text-gray-300">Loading election results...</p>
                        </div>

                        <!-- Results Stats -->
                        <div id="resultStats" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                                <div class="flex items-center mb-4">
                                    <div class="rounded-full bg-blue-100 dark:bg-blue-900/30 p-3 mr-3">
                                        <i class="fas fa-check-square text-blue-500"></i>
                                    </div>
                                    <h3 class="text-lg font-medium">Total Votes Cast</h3>
                                </div>
                                <p id="totalVotesCast" class="text-3xl font-bold text-center mt-2">-</p>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                                <div class="flex items-center mb-4">
                                    <div class="rounded-full bg-green-100 dark:bg-green-900/30 p-3 mr-3">
                                        <i class="fas fa-trophy text-green-500"></i>
                                    </div>
                                    <h3 class="text-lg font-medium">Leading Candidate</h3>
                                </div>
                                <p id="leadingCandidate" class="text-3xl font-bold text-center mt-2">-</p>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                                <div class="flex items-center mb-4">
                                    <div class="rounded-full bg-purple-100 dark:bg-purple-900/30 p-3 mr-3">
                                        <i class="fas fa-users text-purple-500"></i>
                                    </div>
                                    <h3 class="text-lg font-medium">Voter Turnout</h3>
                                </div>
                                <p id="voterTurnout" class="text-3xl font-bold text-center mt-2">-</p>
                            </div>
                        </div>

                        <!-- Results Table -->
                        <div id="resultsTable" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <i class="fas fa-table mr-2"></i>
                                    Detailed Results
                                </h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Candidate
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Party
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Votes
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Percentage
                                            </th>
                                            <th scope="col"
                                                class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Edit
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
                                        id="resultsTableBody">
                                        <!-- Results will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Results Chart -->
                        <div id="resultsChartContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    Results Visualization
                                </h2>
                            </div>
                            <div class="p-4">
                                <div class="w-full h-80">
                                    <canvas id="resultsChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Export Results -->
                        <div id="exportResultsContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <i class="fas fa-file-export mr-2"></i>
                                    Export Results
                                </h2>
                            </div>
                            <div class="p-6">
                                <p class="mb-4 text-gray-700 dark:text-gray-300">
                                    Export the election results to CSV format for further analysis or record keeping.
                                </p>
                                <button id="exportResultsButton"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-700 dark:hover:bg-blue-800">
                                    <i class="fas fa-download mr-2"></i>Download Results (CSV)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Management Tab -->
                <div id="content-config" class="tab-content hidden fade-in" role="tabpanel" aria-labelledby="tab-config">
                    <div class="grid grid-cols-1 gap-8">
                        <!-- System Configuration -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <span class="icon-settings mr-2"></span>
                                    System Configuration
                                </h2>
                            </div>
                            <div class="p-6">
                                <form id="configForm" class="space-y-6">
                                    <!-- Server Configuration -->
                                    <div class="space-y-4">
                                        <h3 class="text-md font-medium text-gray-900 dark:text-gray-100">Server Settings</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="serverPort" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Port</label>
                                                <input type="number" id="serverPort" name="server.port" 
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                            <div>
                                                <label for="serverHost" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Host</label>
                                                <input type="text" id="serverHost" name="server.host" 
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Blockchain Configuration -->
                                    <div class="space-y-4">
                                        <h3 class="text-md font-medium text-gray-900 dark:text-gray-100">Blockchain Settings</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="networkProvider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Network Provider</label>
                                                <input type="text" id="networkProvider" name="blockchain.provider" 
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                            <div>
                                                <label for="gasLimit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Gas Limit</label>
                                                <input type="number" id="gasLimit" name="blockchain.gas.limit" 
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Theme Configuration -->
                                    <div class="space-y-4">
                                        <h3 class="text-md font-medium text-gray-900 dark:text-gray-100">Theme Settings</h3>
                                        <div>
                                            <label for="defaultTheme" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Default Theme</label>
                                            <select id="defaultTheme" name="app.theme.defaultTheme" 
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                                <option value="system">System</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="flex justify-end space-x-4">
                                        <button type="button" id="resetConfig" 
                                            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600">
                                            Reset to Defaults
                                        </button>
                                        <button type="submit" 
                                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        
                        <!-- Configuration Actions -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <span class="icon-settings mr-2"></span>
                                    Configuration Actions
                                </h2>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                        <h3 class="text-md font-medium text-blue-700 dark:text-blue-300 mb-2">Export Configuration</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Save current configuration to a file for backup or transfer.</p>
                                        <button id="exportConfigBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            Export Configuration
                                        </button>
                                    </div>
                                    
                                    <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                        <h3 class="text-md font-medium text-green-700 dark:text-green-300 mb-2">Import Configuration</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Load configuration from a previously exported file.</p>
                                        <label for="importConfigFile" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer inline-block">
                                            Import Configuration
                                        </label>
                                        <input id="importConfigFile" type="file" accept=".json" class="hidden">
                                    </div>
                                    
                                    <div class="p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                        <h3 class="text-md font-medium text-purple-700 dark:text-purple-300 mb-2">Environment Switch</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Switch between configurations for different environments.</p>
                                        <select id="environmentSelect" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                            <option value="development">Development</option>
                                            <option value="production">Production</option>
                                            <option value="testnet">Testnet</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Contract Deployment Tab -->
                <div id="content-deployment" class="tab-content hidden fade-in" role="tabpanel" aria-labelledby="tab-deployment">
                    <div class="grid grid-cols-1 gap-8">
                        <!-- Contract Deployment Wizard -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <span class="icon-file-contract mr-2"></span>
                                    Contract Deployment Wizard
                                </h2>
                            </div>
                            <div class="p-6">
                                <div class="space-y-6">
                                    <!-- Network Selection -->
                                    <div>
                                        <label for="deploymentNetwork" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select Network</label>
                                        <select id="deploymentNetwork" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                                            <option value="development">Development (Local)</option>
                                            <option value="testnet">Testnet</option>
                                            <option value="mainnet">Mainnet</option>
                                        </select>
                                    </div>

                                    <!-- Contract Settings -->
                                    <div class="space-y-4">
                                        <h3 class="text-md font-medium text-gray-900 dark:text-gray-100">Contract Settings</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="adminAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Admin Address</label>
                                                <input type="text" id="adminAddress" 
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600"
                                                    placeholder="0x...">
                                            </div>
                                            <div>
                                                <label for="votingDuration" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Voting Duration (days)</label>
                                                <input type="number" id="votingDuration" 
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600"
                                                    min="1" value="7">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Deployment Progress -->
                                    <div class="space-y-4">
                                        <h3 class="text-md font-medium text-gray-900 dark:text-gray-100">Deployment Progress</h3>
                                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                                            <ol class="space-y-4">
                                                <li class="flex items-center">
                                                    <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-primary-100 dark:bg-primary-900 text-primary-600 dark:text-primary-400">1</span>
                                                    <span class="ml-4 text-sm">Compile Contract</span>
                                                </li>
                                                <li class="flex items-center opacity-50">
                                                    <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800">2</span>
                                                    <span class="ml-4 text-sm">Deploy Contract</span>
                                                </li>
                                                <li class="flex items-center opacity-50">
                                                    <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800">3</span>
                                                    <span class="ml-4 text-sm">Verify Contract</span>
                                                </li>
                                            </ol>
                                        </div>
                                    </div>

                                    <div class="flex justify-end space-x-4">
                                        <button type="button" id="estimateGas" 
                                            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600">
                                            Estimate Gas
                                        </button>
                                        <button type="button" id="deployContract" 
                                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                                            Deploy Contract
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Deployment History -->
                        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <div class="p-4 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-900">
                                <h2 class="text-lg font-semibold text-primary-700 dark:text-primary-300 flex items-center">
                                    <span class="icon-history mr-2"></span>
                                    Deployment History
                                </h2>
                            </div>
                            <div class="p-6">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Contract</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Network</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Address</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deploymentHistoryBody" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                            <!-- Deployment history will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="noDeployments" class="py-8 text-center text-gray-500 dark:text-gray-400 hidden">
                                    No deployment history found.
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </main>

        <!-- Debug Panel (hidden by default) -->
        <div id="debugPanel" class="hidden">
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-mono">Debug Console</h3>
                <button id="clearDebugBtn" class="text-xs text-red-500 hover:text-red-300">Clear</button>
            </div>
            <div id="debugContent"></div>
        </div>
    </div>

    <!-- Initialize particles -->
    <script>
        // Initialize Particles.js
        function initParticles() {
            const fallback = document.getElementById('particles-fallback');
            
            try {
                if (document.getElementById('particles-js') && typeof particlesJS === 'function') {
                    // Updated Particles.js configuration with enhanced interactivity
                    particlesJS('particles-js', {
                        "particles": {
                            "number": {
                                "value": 80,
                                "density": {
                                    "enable": true,
                                    "value_area": 800
                                }
                            },
                            "color": {
                                "value": "#16a34a"  // Using the green color from the theme
                            },
                            "shape": {
                                "type": "circle",
                                "stroke": {
                                    "width": 0,
                                    "color": "#000000"
                                }
                            },
                            "opacity": {
                                "value": 0.5,
                                "random": false,
                                "anim": {
                                    "enable": true,
                                    "speed": 1,
                                    "opacity_min": 0.1,
                                    "sync": false
                                }
                            },
                            "size": {
                                "value": 3,
                                "random": true,
                                "anim": {
                                    "enable": false,
                                    "speed": 40,
                                    "size_min": 0.1,
                                    "sync": false
                                }
                            },
                            "line_linked": {
                                "enable": true,
                                "distance": 150,
                                "color": "#16a34a",  // Using the green color from the theme
                                "opacity": 0.4,
                                "width": 1
                            },
                            "move": {
                                "enable": true,
                                "speed": 3,
                                "direction": "none",
                                "random": false,
                                "straight": false,
                                "out_mode": "out",
                                "bounce": false,
                                "attract": {
                                    "enable": true,
                                    "rotateX": 600,
                                    "rotateY": 1200
                                }
                            }
                        },
                        "interactivity": {
                            "detect_on": "window",
                            "events": {
                                "onhover": {
                                    "enable": true,
                                    "mode": "repulse"
                                },
                                "onclick": {
                                    "enable": true,
                                    "mode": "push"
                                },
                                "resize": true
                            },
                            "modes": {
                                "grab": {
                                    "distance": 180,
                                    "line_linked": {
                                        "opacity": 1
                                    }
                                },
                                "bubble": {
                                    "distance": 250,
                                    "size": 6,
                                    "duration": 2,
                                    "opacity": 0.8,
                                    "speed": 3
                                },
                                "repulse": {
                                    "distance": 100,
                                    "duration": 0.4
                                },
                                "push": {
                                    "particles_nb": 4
                                },
                                "remove": {
                                    "particles_nb": 2
                                }
                            }
                        },
                        "retina_detect": true
                    });
                    
                    // Hide fallback when particles are ready
                    if (fallback) fallback.style.display = 'none';
                }
            } catch (error) {
                console.error("Error initializing Particles.js:", error);
                // Show fallback on error
                if (fallback) fallback.style.display = 'block';
            }
        }

        // Function to update particle colors based on theme
        function updateParticlesColors() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const colors = {
                light: {
                    particles: '#16a34a',
                    lines: '#15803d'
                },
                dark: {
                    particles: '#4ade80',
                    lines: '#22c55e'
                }
            };
            
            const theme = isDarkMode ? colors.dark : colors.light;
            
            if (window.pJSDom && window.pJSDom[0] && window.pJSDom[0].pJS) {
                const pJS = window.pJSDom[0].pJS;
                
                // Update particle colors
                pJS.particles.color.value = theme.particles;
                pJS.particles.line_linked.color = theme.lines;
                
                // Update existing particles
                pJS.particles.array.forEach(p => {
                    p.color.value = theme.particles;
                    p.color.rgb = hexToRgb(theme.particles);
                });
                
                // Update lines
                pJS.particles.line_linked.color_rgb_line = hexToRgb(theme.lines);
            }
        }

        // Initialize particles
        document.addEventListener('DOMContentLoaded', function() {
            initParticles();
            
            // Update particles colors when theme changes
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    setTimeout(updateParticlesColors, 100);
                });
            }
        });

        // Cleanup function
        function cleanupParticles() {
            if (window.pJSDom && window.pJSDom[0] && window.pJSDom[0].pJS) {
                window.pJSDom[0].pJS.fn.vendors.destroypJS();
                window.pJSDom = [];
            }
        }

        // Call cleanup when needed
        window.addEventListener('unload', cleanupParticles);
    </script>

    <!-- Contract ABI Definition -->
    <script>
        // Define the ABI for the voting contract
        const votingContractABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "candidateId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "party",
                        "type": "string"
                    }
                ],
                "name": "CandidateAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "candidateId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "newVoteCount",
                        "type": "uint256"
                    }
                ],
                "name": "VoteCast",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "startTime",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "endTime",
                        "type": "uint256"
                    }
                ],
                "name": "VotingPeriodSet",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_name",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "_party",
                        "type": "string"
                    }
                ],
                "name": "addCandidate",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "admin",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "candidates",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "id",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "party",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "voteCount",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "candidateCount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAllCandidates",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "uint256",
                                "name": "id",
                                "type": "uint256"
                            },
                            {
                                "internalType": "string",
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "party",
                                "type": "string"
                            },
                            {
                                "internalType": "uint256",
                                "name": "voteCount",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct Voting.Candidate[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_candidateId",
                        "type": "uint256"
                    }
                ],
                "name": "getCandidate",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getCandidateCount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getVotingPeriod",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "hasVoted",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "endTime",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_startTime",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_endTime",
                        "type": "uint256"
                    }
                ],
                "name": "setVotingPeriod",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "startTime",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_candidateId",
                        "type": "uint256"
                    }
                ],
                "name": "vote",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
    </script>

    <!-- Main Application Script -->
    <script>
        let web3 = null;
        let votingContract = null;
        let accounts = [];
        let isAdmin = false;
        let candidatesData = [];
        let votingStartTime = 0;
        let votingEndTime = 0;
        let chartInstance = null;
        
        // Application configuration
        const appConfig = {
            // Contract address will be loaded dynamically from build files
            contractAddress: null,
            networkName: 'Ganache Local', // Local network
            defaultImageUrl: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png',
        };
        
        // Debug log function
        function debugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const time = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div class="py-1">[${time}] ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        
        // ==========================================
        // Initialization Functions
        // ==========================================
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('Application initializing...');
            
            // Initialize theme based on user preference
            if (localStorage.getItem('theme') === 'dark' || 
                (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Try auto-connecting if user has previously connected
            if (localStorage.getItem('walletConnected') === 'true') {
                connectWallet();
            } else {
                updateUIConnectionStatus(false);
            }
        });
        
        // Setup all event listeners
        function setupEventListeners() {
            // Connect wallet buttons
            const connectButton = document.getElementById('connectButton');
            const connectButtonPanel = document.getElementById('connectButtonPanel');
            
            if (connectButton) {
                console.log('Adding click event listener to main connect button');
                connectButton.addEventListener('click', function(event) {
                    console.log('Main connect button clicked');
                    connectWallet();
                });
            } else {
                console.log('Main connect button not found');
            }
            
            if (connectButtonPanel) {
                console.log('Adding click event listener to panel connect button');
                connectButtonPanel.addEventListener('click', function(event) {
                    console.log('Panel connect button clicked');
                    connectWallet();
                });
            } else {
                console.log('Panel connect button not found');
            }
            
            // Refresh data button
            const refreshDataButton = document.getElementById('refreshDataButton');
            if (refreshDataButton) {
                refreshDataButton.addEventListener('click', refreshAllData);
            }
            
            // Add candidate form
            const addCandidateForm = document.getElementById('addCandidateForm');
            if (addCandidateForm) {
                addCandidateForm.addEventListener('submit', handleAddCandidate);
            }
            
            // Edit candidate form
            const editCandidateForm = document.getElementById('editCandidateForm');
            if (editCandidateForm) {
                editCandidateForm.addEventListener('submit', handleEditCandidate);
            }
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Refresh candidates button
            const refreshCandidatesButton = document.getElementById('refreshCandidatesButton');
            if (refreshCandidatesButton) {
                refreshCandidatesButton.addEventListener('click', loadCandidates);
            }
            
            // Set dates form
            const setDatesForm = document.getElementById('setDatesForm');
            if (setDatesForm) {
                setDatesForm.addEventListener('submit', handleSetDates);
            }
            
            // Update dates button
            const updateDatesButton = document.getElementById('updateDatesButton');
            if (updateDatesButton) {
                updateDatesButton.addEventListener('click', handleUpdateDates);
            }
            
            // Export results button
            const exportResultsButton = document.getElementById('exportResultsButton');
            if (exportResultsButton) {
                exportResultsButton.addEventListener('click', exportResults);
            }
            
            // Logout button
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', disconnectWallet);
            }
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Get the target content ID
                    const targetId = this.getAttribute('aria-controls');
                    
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show the selected tab content
                    document.getElementById(targetId).classList.add('active');
                    
                    // Update tab button styles
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('text-primary-600', 'dark:text-primary-400', 'border-primary-500', 'dark:border-primary-400');
                        btn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-primary-600', 'dark:hover:text-primary-400', 'border-transparent');
                    });
                    
                    // Style the clicked tab button
                    this.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-primary-600', 'dark:hover:text-primary-400', 'border-transparent');
                    this.classList.add('text-primary-600', 'dark:text-primary-400', 'border-primary-500', 'dark:border-primary-400');
                    
                    // If results tab is selected, load results data
                    if (targetId === 'content-results') {
                        loadResults();
                    }
                });
            });
            
            // Dark mode toggle
            document.getElementById('themeToggle').addEventListener('click', function() {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            // Clear debug button
            document.getElementById('clearDebugBtn').addEventListener('click', function() {
                document.getElementById('debugContent').innerHTML = '';
            });
        }
        
        // ==========================================
        // Wallet Connection Functions
        // ==========================================
        
        // Add this before the connectWallet function
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet',
                '0x5': 'Goerli Testnet',
                '0x2a': 'Kovan Testnet',
                '0x539': 'Localhost 1337',
                '0x89': 'Polygon Mainnet',
                '0x13881': 'Mumbai Testnet',
                '0x1B57': 'Localhost 7575'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }
        
        // Replace the existing connectWallet function
        async function connectWallet() {
            try {
                debugLog("Connecting wallet...");
                
                // Check if Web3 is loaded
                if (typeof Web3 === 'undefined') {
                    debugLog('Web3 library not loaded');
                    showFeedback('candidateFeedback', 'error', 'Web3 Not Loaded', 'The Web3 library failed to load. Please refresh the page and try again.');
                    return false;
                }
                
                // Check if MetaMask is installed
                if (!window.ethereum) {
                    debugLog('No Ethereum provider found');
                    showFeedback('walletFeedback', 'error', 'Wallet Not Found', 'Please install MetaMask or another Ethereum wallet to use this application.');
                    return false;
                }
                
                // Request account access
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                debugLog(`Connected account: ${accounts[0]}`);
                
                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                debugLog(`Connected to network: ${getNetworkName(chainId)}`);
                
                // Initialize Web3
                web3 = new Web3(window.ethereum);
                
                // Load dynamic contract address from build files
                try {
                    appConfig.contractAddress = await window.contractLoader.loadContractAddress();
                    debugLog(`Loaded contract address: ${appConfig.contractAddress}`);
                } catch (error) {
                    debugLog(`Error loading contract address: ${error.message}`);
                    showFeedback('walletFeedback', 'error', 'Contract Not Found', 'Failed to load contract address. Please ensure the contract is deployed.');
                    return false;
                }
                
                // Initialize contract
                votingContract = new web3.eth.Contract(votingContractABI, appConfig.contractAddress);
                debugLog('Contract initialized with address: ' + appConfig.contractAddress);
                
                // Update UI
                updateUIConnectionStatus(true);
                
                // Check if user is admin
                checkAdminAccess();
                
                // Load initial data
                refreshAllData();
                
                // Mark as connected in local storage
                localStorage.setItem('walletConnected', 'true');
                
                return true;
            } catch (error) {
                debugLog(`Wallet connection error: ${error.message}`);
                showFeedback('walletFeedback', 'error', 'Connection Failed', error.message);
                updateUIConnectionStatus(false);
                return false;
            }
        }
        
        // Handle when user changes accounts
        async function handleAccountsChanged(newAccounts) {
            debugLog('Accounts changed, updating...');
            accounts = newAccounts;
            
            if (accounts.length === 0) {
                // User disconnected their wallet
                disconnectWallet();
            } else {
                // Check if new account is admin
                await checkAdminStatus();
                await refreshAllData();
            }
        }
        
        // Disconnect the wallet
        function disconnectWallet() {
            debugLog('Disconnecting wallet...');
            
            // Show loading state on logout button
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.disabled = true;
                logoutButton.innerHTML = '<div class="loader"></div><span>Logging out...</span>';
            }
            
            // Reset global variables
            accounts = [];
            isAdmin = false;
            contractConnected = false;
            debugLog('Contract connected status:', contractConnected);
            
            // Update UI
            updateUIConnectionStatus(false);
            
            // Clear all authentication related data from localStorage
            localStorage.removeItem('walletConnected');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('user_id');
            localStorage.removeItem('national_id');
            localStorage.removeItem('wallet_address');
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('voterId');
            localStorage.removeItem('isAuthenticated');
            
            // Reset UI elements to loading/default state
            document.getElementById('candidateList').innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center">Connect your wallet to view candidates</td></tr>';
            document.getElementById('totalCandidates').textContent = '-';
            document.getElementById('totalVotes').textContent = '-';
            document.getElementById('votingStatus').textContent = '-';
            document.getElementById('timeRemaining').textContent = '-';
            document.getElementById('currentDatesDisplay').textContent = 'Connect your wallet to view voting period';
            
            // Hide feedback messages
            document.getElementById('candidateFeedbackContainer').classList.add('hidden');
            document.getElementById('datesFeedbackContainer').classList.add('hidden');
            
            debugLog('Wallet disconnected and user logged out');
            
            // Redirect to login page after a short delay
            setTimeout(() => {
                window.location.href = "login.html?logout=success&t=" + new Date().getTime();
            }, 500);
        }
        
        // Check if connected account is the contract admin
                async function checkAdminStatus() {
            try {
                const adminAddress = await votingContract.methods.admin().call();
                return adminAddress.toLowerCase() === accounts[0].toLowerCase();
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }
        
        async function updateUIForAdminStatus() {
            const isAdmin = await checkAdminStatus();
            const adminOnlyElements = document.querySelectorAll('[data-admin-only="true"]');
            
            adminOnlyElements.forEach(element => {
                if (isAdmin) {
                    element.classList.remove('opacity-50', 'cursor-not-allowed');
                    element.disabled = false;
                } else {
                    element.classList.add('opacity-50', 'cursor-not-allowed');
                    element.disabled = true;
                }
            });
        }
        
        // Update UI elements based on connection status
        function updateUIConnectionStatus(isConnected) {
            const connectButton = document.getElementById('connectButton');
            const connectButtonPanel = document.getElementById('connectButtonPanel');
            const disconnectButton = document.getElementById('disconnectButton');
            const walletStatus = document.getElementById('walletStatus');
            const networkInfo = document.getElementById('networkInfo');
            const contractInfo = document.getElementById('contractInfo');
            
            if (isConnected) {
                if (connectButton) connectButton.classList.add('hidden');
                if (connectButtonPanel) connectButtonPanel.classList.add('hidden');
                if (disconnectButton) disconnectButton.classList.remove('hidden');
                if (walletStatus) walletStatus.textContent = `Connected: ${accounts[0].substring(0, 6)}...${accounts[0].substring(accounts[0].length - 4)}`;
                if (networkInfo) networkInfo.textContent = `Connected to ${appConfig.networkName}`;
                if (contractInfo) contractInfo.textContent = `Contract: ${appConfig.contractAddress.substring(0, 6)}...${appConfig.contractAddress.substring(appConfig.contractAddress.length - 4)}`;
            } else {
                if (connectButton) connectButton.classList.remove('hidden');
                if (connectButtonPanel) connectButtonPanel.classList.remove('hidden');
                if (disconnectButton) disconnectButton.classList.add('hidden');
                if (walletStatus) walletStatus.textContent = 'Not Connected';
                if (networkInfo) networkInfo.textContent = 'Not Connected';
                if (contractInfo) contractInfo.textContent = 'Not Connected';
            }
        }
        
        // Add the updateNetworkInfo function
        function updateNetworkInfo() {
            const networkInfo = document.getElementById('networkInfo');
            const contractInfo = document.getElementById('contractInfo');
            
                if (networkInfo) {
                    networkInfo.textContent = `Connected to ${appConfig.networkName}`;
                }
            
                if (contractInfo) {
                    contractInfo.textContent = `Contract: ${appConfig.contractAddress.substring(0, 6)}...${appConfig.contractAddress.substring(appConfig.contractAddress.length - 4)}`;
            }
        }
        
        // ==========================================
        // Data Loading Functions
        // ==========================================
        
        // Refresh all data displayed in the dashboard
        async function refreshAllData() {
            debugLog('Refreshing all data...');
            
            if (!web3 || !votingContract) {
                debugLog('Cannot refresh data: Wallet not connected');
                return;
            }
            
            try {
                // Load data in parallel
                await Promise.all([
                    loadCandidates(),
                    loadVotingPeriod(),
                    loadVotingStats()
                ]);
                
                // Update results tab data if that tab is active
                if (document.getElementById('content-results').classList.contains('active')) {
                    loadResults();
                }
                
                debugLog('All data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing data:', error);
                debugLog('Error refreshing data: ' + error.message);
            }
        }
        
        // Load candidates from the contract
        async function loadCandidates() {
            debugLog('Loading candidates...');
            
            try {
                if (!web3 || !votingContract) {
                    throw new Error('Web3 or contract not initialized');
                }
                
                // Get candidates from contract
                const candidates = await votingContract.methods.getAllCandidates().call();
                debugLog(`Received ${candidates.length} candidates from contract`);
                
                // Update candidates data
                candidatesData = candidates;
                
                // Update total candidates counter
                document.getElementById('totalCandidates').textContent = candidates.length;
                
                if (candidates.length === 0) {
                    candidateList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-4 py-6 text-center">
                                <p class="text-gray-500 dark:text-gray-400">No candidates found. Add new candidates to get started.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Build candidate list HTML
                const candidateListHTML = candidates.map(candidate => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-750">
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300">
                                ${candidate.id}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <div class="h-10 w-10 flex-shrink-0 mr-3">
                                    <img class="h-10 w-10 rounded-full object-cover" 
                                         src="${candidate.imageUrl || appConfig.defaultImageUrl}" 
                                         alt="${candidate.name}">
                                </div>
                                <div>
                                    <p class="font-medium">${candidate.name}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                                ${candidate.party}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="font-medium">${candidate.voteCount}</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <button 
                                class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300"
                                onclick="openEditCandidateModal(${candidate.id}, '${candidate.name}', '${candidate.party}', '${candidate.imageUrl || appConfig.defaultImageUrl}')"
                            >
                                <span class="icon-edit"></span>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // Update the UI
                candidateList.innerHTML = candidateListHTML;
                
                debugLog('Candidates loaded successfully');
            } catch (error) {
                console.error('Error loading candidates:', error);
                debugLog('Error loading candidates: ' + error.message);
                
                candidateList.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-6 text-center">
                            <p class="text-red-500 dark:text-red-400">Error loading candidates: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Load voting period information from the contract
        async function loadVotingPeriod() {
            try {
                if (!await isContractInitialized()) {
                    throw new Error('Contract not initialized or not accessible');
                }
                
                // Get voting period from contract
                const result = await votingContract.methods.getVotingPeriod().call();
                
                // Handle the return value - it might be an object with properties or an array
                let startTime, endTime;
                
                if (typeof result === 'object') {
                    // If it's an object with properties
                    if ('startTime' in result && 'endTime' in result) {
                        startTime = result.startTime;
                        endTime = result.endTime;
                    } 
                    // If it's an array-like object
                    else if (Array.isArray(result) || (typeof result[0] !== 'undefined' && typeof result[1] !== 'undefined')) {
                        startTime = result[0];
                        endTime = result[1];
                    } else {
                        throw new Error('Invalid voting period data format');
                    }
                } else {
                    throw new Error('Invalid voting period data format');
                }
                
                // Convert to numbers and validate
                startTime = Number(startTime);
                endTime = Number(endTime);
                
                if (isNaN(startTime) || isNaN(endTime)) {
                    throw new Error('Invalid voting period values');
                }
                
                votingStartTime = startTime;
                votingEndTime = endTime;
                
                updateVotingPeriodUI();
                debugLog('Voting period loaded successfully');
            } catch (error) {
                console.error('Error loading voting period:', error);
                debugLog('Error loading voting period: ' + error.message);
                showFeedback('datesFeedback', 'error', 'Error Loading Voting Period', error.message);
            }
        }
        
        // Load voting stats (status and time remaining)
        async function loadVotingStats() {
            debugLog('Loading voting stats...');
            
            try {
                // Get voting status based on current time and voting period
                const now = Math.floor(Date.now() / 1000); // Current time in seconds
                const isActive = now >= votingStartTime && now <= votingEndTime;
                
                // Update voting status display
                const statusElement = document.getElementById('votingStatus');
                if (votingStartTime === 0 && votingEndTime === 0) {
                    statusElement.textContent = 'Not Set';
                    statusElement.classList.remove('text-green-500', 'text-red-500', 'text-gray-500');
                    statusElement.classList.add('text-yellow-500');
                } else if (isActive) {
                    statusElement.textContent = 'Active';
                    statusElement.classList.remove('text-yellow-500', 'text-red-500', 'text-gray-500');
                    statusElement.classList.add('text-green-500');
                } else {
                    const now = Math.floor(Date.now() / 1000);
                    if (now < votingStartTime) {
                        statusElement.textContent = 'Upcoming';
                        statusElement.classList.remove('text-green-500', 'text-red-500', 'text-yellow-500');
                        statusElement.classList.add('text-gray-500');
                    }
                    else {
                        statusElement.textContent = 'Ended';
                        statusElement.classList.remove('text-green-500', 'text-gray-500', 'text-yellow-500');
                        statusElement.classList.add('text-red-500');
                    }
                }
                
                // Update time remaining display
                updateTimeRemaining();
                
                // Start timer to update time remaining
                if (isActive) {
                    // Update every second
                    setInterval(updateTimeRemaining, 1000);
                }
                
                debugLog('Voting stats loaded successfully');
            } catch (error) {
                console.error('Error loading voting stats:', error);
                debugLog('Error loading voting stats: ' + error.message);
            }
        }
        
        // Load and display election results
        async function loadResults() {
            debugLog('Loading election results...');
            
            // Show loading indicator
            document.getElementById('resultsLoading').classList.remove('hidden');
            document.getElementById('resultStats').classList.add('hidden');
            document.getElementById('resultsTable').classList.add('hidden');
            document.getElementById('resultsChartContainer').classList.add('hidden');
            document.getElementById('exportResultsContainer').classList.add('hidden');
            
            try {
                // Make sure candidates are loaded
                if (candidatesData.length === 0) {
                    await loadCandidates();
                }
                
                // If still no candidates
                if (candidatesData.length === 0) {
                    document.getElementById('resultsLoadingText').textContent = 'No candidates found. Add candidates first.';
                    return;
                }
                
                // Calculate total votes
                const totalVotes = candidatesData.reduce((sum, candidate) => sum + parseInt(candidate.voteCount), 0);
                document.getElementById('totalVotesCast').textContent = totalVotes;
                
                // Find leading candidate
                let leadingCandidate = { name: 'None', voteCount: 0 };
                
                candidatesData.forEach(candidate => {
                    if (parseInt(candidate.voteCount) > parseInt(leadingCandidate.voteCount)) {
                        leadingCandidate = candidate;
                    }
                });
                
                document.getElementById('leadingCandidate').textContent = totalVotes > 0 ? leadingCandidate.name : 'No votes cast';
                
                // Calculate voter turnout (if we had total eligible voters data)
                // For now, just use a placeholder
                document.getElementById('voterTurnout').textContent = totalVotes > 0 ? 'Available voters have participated' : 'No votes cast';
                
                // Build results table
                let resultsTableHTML = '';
                
                candidatesData.forEach(candidate => {
                    const percentage = totalVotes > 0 ? ((parseInt(candidate.voteCount) / totalVotes) * 100).toFixed(2) : '0.00';
                    
                    resultsTableHTML += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-750">
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <div class="h-10 w-10 flex-shrink-0 mr-3">
                                        <img class="h-10 w-10 rounded-full object-cover" 
                                             src="${candidate.imageUrl || appConfig.defaultImageUrl}" 
                                             alt="${candidate.name}">
                                    </div>
                                    <div>
                                        <p class="font-medium">${candidate.name}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                                    ${candidate.party}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="font-medium">${candidate.voteCount}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex items-center justify-end">
                                    <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                        <div class="bg-primary-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span>${percentage}%</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <button 
                                    class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300"
                                    onclick="openEditCandidateModal(${candidate.id}, '${candidate.name}', '${candidate.party}', '${candidate.imageUrl || appConfig.defaultImageUrl}')"
                                >
                                    <span class="icon-edit"></span>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Update table
                document.getElementById('resultsTableBody').innerHTML = resultsTableHTML;
                
                // Create chart
                createResultsChart();
                
                // Hide loading and show results
                document.getElementById('resultsLoading').classList.add('hidden');
                document.getElementById('resultStats').classList.remove('hidden');
                document.getElementById('resultsTable').classList.remove('hidden');
                document.getElementById('resultsChartContainer').classList.remove('hidden');
                document.getElementById('exportResultsContainer').classList.remove('hidden');
                
                debugLog('Election results loaded successfully');
            } catch (error) {
                console.error('Error loading results:', error);
                debugLog('Error loading results: ' + error.message);
                
                document.getElementById('resultsLoadingIndicator').classList.add('hidden');
                document.getElementById('resultsLoadingText').textContent = 'Error loading results. Please try again.';
            }
        }
        
        // ==========================================
        // UI Update Functions
        // ==========================================
        
        // Update the UI with voting period information
        function updateVotingPeriodUI() {
            const currentDatesDisplay = document.getElementById('currentDatesDisplay');
            const votingStatusBadge = document.getElementById('votingStatusBadge');
            const electionProgressContainer = document.getElementById('electionProgressContainer');
            
            // If voting period not set
            if (votingStartTime === 0 && votingEndTime === 0) {
                currentDatesDisplay.textContent = 'No voting period has been set.';
                votingStatusBadge.classList.add('hidden');
                electionProgressContainer.classList.add('hidden');
                return;
            }
            
            // Format dates for display
            const startDate = new Date(votingStartTime * 1000);
            const endDate = new Date(votingEndTime * 1000);
            const dateOptions = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit'
            };
            
            const formattedStart = startDate.toLocaleDateString('en-US', dateOptions);
            const formattedEnd = endDate.toLocaleDateString('en-US', dateOptions);
            
            currentDatesDisplay.textContent = `From ${formattedStart} to ${formattedEnd}`;
            
            // Show voting status badge
            votingStatusBadge.classList.remove('hidden');
            
            const now = new Date();
            
            if (now < startDate) {
                // Upcoming election
                votingStatusBadge.textContent = 'Upcoming';
                votingStatusBadge.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                votingStatusBadge.classList.add('bg-gray-100', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-300');
            } else if (now > endDate) {
                // Ended election
                votingStatusBadge.textContent = 'Ended';
                votingStatusBadge.classList.remove('bg-green-100', 'text-green-800', 'bg-gray-100', 'text-gray-800');
                votingStatusBadge.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/30', 'dark:text-red-300');
            } else {
                // Active election
                votingStatusBadge.textContent = 'Active';
                votingStatusBadge.classList.remove('bg-gray-100', 'text-gray-800', 'bg-red-100', 'text-red-800');
                votingStatusBadge.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-300');
            }
            
            // Update election progress
            updateElectionProgress(startDate, endDate);
        }
        
        // Update election progress bar and time remaining
        function updateElectionProgress(startDate, endDate) {
            const now = new Date();
            const electionProgressContainer = document.getElementById('electionProgressContainer');
            const electionProgress = document.getElementById('electionProgress');
            const electionStartLabel = document.getElementById('electionStartLabel');
            const electionEndLabel = document.getElementById('electionEndLabel');
            const electionTimeRemaining = document.getElementById('electionTimeRemaining');
            
            // Format dates for display
            const dateOptions = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            electionStartLabel.textContent = startDate.toLocaleDateString('en-US', dateOptions);
            electionEndLabel.textContent = endDate.toLocaleDateString('en-US', dateOptions);
            
            // Calculate progress percentage
            let progressPercentage = 0;
            
            if (now > endDate) {
                // Election ended
                progressPercentage = 100;
            } else if (now < startDate) {
                // Election not started
                progressPercentage = 0;
            } else {
                // Election in progress
                const totalDuration = endDate - startDate;
                const elapsed = now - startDate;
                progressPercentage = Math.min(100, Math.floor((elapsed / totalDuration) * 100));
            }
            
            // Update progress bar
            electionProgress.style.width = `${progressPercentage}%`;
            
            // Set progress bar color
            if (progressPercentage === 100) {
                electionProgress.classList.remove('bg-primary-500', 'bg-yellow-500');
                electionProgress.classList.add('bg-red-500');
            } else if (progressPercentage > 75) {
                electionProgress.classList.remove('bg-primary-500', 'bg-red-500');
                electionProgress.classList.add('bg-yellow-500');
            } else {
                electionProgress.classList.remove('bg-yellow-500', 'bg-red-500');
                electionProgress.classList.add('bg-primary-500');
            }
            
            // Show progress container
            electionProgressContainer.classList.remove('hidden');
            
            // Update time remaining
            updateTimeRemaining();
        }
        
        // Update time remaining display
        function updateTimeRemaining() {
            const now = Math.floor(Date.now() / 1000);
            const timeRemainingElement = document.getElementById('timeRemaining');
            const electionTimeRemaining = document.getElementById('electionTimeRemaining');
            
            // If voting period not set
            if (votingStartTime === 0 && votingEndTime === 0) {
                timeRemainingElement.textContent = 'Not Set';
                if (electionTimeRemaining) {
                    electionTimeRemaining.textContent = 'Voting period not set';
                }
                return;
            }
            
            // Calculate appropriate time remaining
            let timeRemaining;
            let statusText;
            
            if (now < votingStartTime) {
                // Time until voting starts
                timeRemaining = votingStartTime - now;
                statusText = 'until voting begins';
            } else if (now < votingEndTime) {
                // Time until voting ends
                timeRemaining = votingEndTime - now;
                statusText = 'until voting ends';
            } else {
                // Voting ended
                timeRemainingElement.textContent = 'Ended';
                if (electionTimeRemaining) {
                    electionTimeRemaining.textContent = 'Voting has ended';
                }
                return;
            }
            
            // Format time remaining
            const days = Math.floor(timeRemaining / 86400);
            const hours = Math.floor((timeRemaining % 86400) / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            let formattedTime = '';
            
            if (days > 0) {
                formattedTime = `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                formattedTime = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                formattedTime = `${minutes}m ${seconds}s`;
            }
            
            // Update UI
            timeRemainingElement.textContent = formattedTime;
            if (electionTimeRemaining) {
                electionTimeRemaining.textContent = `${formattedTime} ${statusText}`;
            }
        }
        
        // Display feedback messages to the user
        function showFeedback(type, status, title, message) {
            try {
                // Get feedback elements with null checks
            const container = document.getElementById(`${type}Container`);
            const titleElement = document.getElementById(`${type}Title`);
            const messageElement = document.getElementById(`${type}`);
            const iconElement = document.getElementById(`${type}Icon`);
                
                // Log error if elements are missing
                if (!container || !titleElement || !messageElement) {
                    console.error(`Missing feedback elements for type: ${type}`);
                    // Create feedback elements if they don't exist
                    createFeedbackElements(type);
                    return showFeedback(type, status, title, message); // Retry after creating elements
                }
            
            // Set message content
                titleElement.textContent = title || '';
                messageElement.textContent = message || '';
            
            // Set appropriate styling based on status
                container.classList.remove('hidden', 'border-green-200', 'border-red-200', 'border-yellow-200', 
                                         'bg-green-50', 'bg-red-50', 'bg-yellow-50',
                                         'dark:bg-green-900/20', 'dark:bg-red-900/20', 'dark:bg-yellow-900/20',
                                         'dark:border-green-900', 'dark:border-red-900', 'dark:border-yellow-900');
                titleElement.classList.remove('text-green-800', 'text-red-800', 'text-yellow-800',
                                            'dark:text-green-300', 'dark:text-red-300', 'dark:text-yellow-300');
            
            // Set icon based on notification type
            let iconClass = '';
            
            switch (status) {
                case 'success':
                    container.classList.add('border-green-200', 'bg-green-50', 'dark:bg-green-900/20', 'dark:border-green-900');
                    titleElement.classList.add('text-green-800', 'dark:text-green-300');
                    iconClass = '<span class="icon-check-circle text-green-500"></span>';
                    break;
                case 'error':
                    container.classList.add('border-red-200', 'bg-red-50', 'dark:bg-red-900/20', 'dark:border-red-900');
                    titleElement.classList.add('text-red-800', 'dark:text-red-300');
                        iconClass = '<span class="icon-x-circle text-red-500"></span>';
                    break;
                case 'warning':
                    container.classList.add('border-yellow-200', 'bg-yellow-50', 'dark:bg-yellow-900/20', 'dark:border-yellow-900');
                    titleElement.classList.add('text-yellow-800', 'dark:text-yellow-300');
                        iconClass = '<span class="icon-exclamation-circle text-yellow-500"></span>';
                    break;
                    default:
                        console.warn(`Unknown feedback status: ${status}`);
                }
                
                // Update icon if element exists
                if (iconElement) {
            iconElement.innerHTML = iconClass;
                }
            
            // Show the container
            container.classList.remove('hidden');
            
                // Auto-hide after 5 seconds for success messages
            if (status === 'success') {
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 5000);
            }
            } catch (error) {
                console.error('Error in showFeedback:', error);
            }
        }
        
        // Helper function to create feedback elements if they don't exist
        function createFeedbackElements(type) {
            const mainContainer = document.getElementById('mainContent');
            if (!mainContainer) {
                console.error('Main container not found');
                return;
            }
            
            // Create feedback container
            const container = document.createElement('div');
            container.id = `${type}Container`;
            container.className = 'hidden fixed top-4 right-4 p-4 rounded-lg border shadow-lg max-w-md z-50';
            
            // Create title element
            const title = document.createElement('h3');
            title.id = `${type}Title`;
            title.className = 'font-semibold mb-1';
            
            // Create message element
            const message = document.createElement('p');
            message.id = `${type}`;
            message.className = 'text-sm';
            
            // Create icon element
            const icon = document.createElement('div');
            icon.id = `${type}Icon`;
            icon.className = 'absolute top-4 right-4';
            
            // Assemble the feedback element
            container.appendChild(title);
            container.appendChild(message);
            container.appendChild(icon);
            
            // Add to main container
            mainContainer.appendChild(container);
        }
        
        // Create a chart to visualize election results
        function createResultsChart() {
            // Get canvas element
            const chartCanvas = document.getElementById('resultsChart');
            
            // If chart already exists, destroy it
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Prepare data for the chart
            const labels = candidatesData.map(candidate => candidate.name);
            const votes = candidatesData.map(candidate => parseInt(candidate.voteCount));
            const colors = generateColors(candidatesData.length);
            
            // Create chart
            chartInstance = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Votes',
                        data: votes,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = votes.reduce((sum, vote) => sum + vote, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0%';
                                    return `Votes: ${value} (${percentage})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Generate colors for chart
        function generateColors(count) {
            const colors = [
                'rgba(14, 165, 233, 0.7)',  // Sky blue
                'rgba(168, 85, 247, 0.7)',  // Purple
                'rgba(234, 88, 12, 0.7)',   // Orange
                'rgba(22, 163, 74, 0.7)',   // Green
                'rgba(225, 29, 72, 0.7)',   // Red
                'rgba(20, 184, 166, 0.7)',  // Teal
                'rgba(245, 158, 11, 0.7)',  // Amber
                'rgba(236, 72, 153, 0.7)',  // Pink
            ];
            
            // If we need more colors than in our predefined list, generate them
            if (count > colors.length) {
                for (let i = colors.length; i < count; i++) {
                    const r = Math.floor(Math.random() * 255);
                    const g = Math.floor(Math.random() * 255);
                    const b = Math.floor(Math.random() * 255);
                    colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
                }
            }
            
            return colors.slice(0, count);
        }
        
        // ==========================================
        // Form Handling Functions
        // ==========================================
        
        // Handle adding a new candidate
        async function handleAddCandidate(event) {
            event.preventDefault();
            debugLog('Handling add candidate submission...');
            
            if (!web3 || !votingContract) {
                showFeedback('candidateFeedback', 'error', 'Connection Error', 'Please connect your wallet first.');
                return;
            }
            
            if (!isAdmin) {
                showFeedback('candidateFeedback', 'error', 'Permission Denied', 'Only the admin can add candidates.');
                return;
            }
            
            const nameInput = document.getElementById('name');
            const partyInput = document.getElementById('party');
            const imageUrlInput = document.getElementById('imageUrl');
            const addButton = document.getElementById('addCandidateButton');
            
            const name = nameInput.value.trim();
            const party = partyInput.value.trim();
            const imageUrl = imageUrlInput.value.trim() || appConfig.defaultImageUrl;
            
            // Validate inputs
            if (!validateCandidateForm(name, party)) {
                return;
            }
            
            debugLog(`Attempting to add candidate: ${name} (${party})`);
            
            // Show loading state
            addButton.innerHTML = '<div class="loader"></div> Adding...';
            addButton.disabled = true;
            
            try {
                // Call the contract method
                const transaction = await votingContract.methods.addCandidate(name, party)
                    .send({ 
                        from: accounts[0],
                        gas: 500000 // Specify gas limit
                    });
                
                debugLog(`Transaction successful: ${transaction.transactionHash}`);
                
                // Show success feedback
                showFeedback('candidateFeedback', 'success', 'Candidate Added', 
                    `${name} has been added as a candidate successfully.`);
                
                // Reset form
                document.getElementById('addCandidateForm').reset();
                
                // Refresh the candidates list
                await loadCandidates();
                
            } catch (error) {
                console.error('Error adding candidate:', error);
                debugLog(`Error adding candidate: ${error.message}`);
                
                showFeedback('candidateFeedback', 'error', 'Transaction Failed', 
                    'Failed to add candidate. ' + error.message);
            } finally {
                // Reset button state
                addButton.innerHTML = '<span class="icon-plus-circle mr-2"></span>Add Candidate';
                addButton.disabled = false;
            }
        }
        
        // Function to validate candidate form
        function validateCandidateForm(name, party) {
            if (!name || !party) {
                return false;
            }
            return true;
        }
        
        // Helper function to check if a date is in the future with a buffer
        function isDateInFuture(date, bufferMinutes = 5) {
            const now = new Date();
            const bufferTime = new Date(now.getTime() + (bufferMinutes * 60 * 1000));
            return date > bufferTime;
        }
        
        // Handle setting voting dates
        async function handleSetDates(event) {
            event.preventDefault();
            
            if (!isAdmin) {
                showFeedback('datesFeedback', 'error', 'Permission Denied', 'Only the admin can set voting dates.');
                return;
            }
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const setButton = document.getElementById('setDatesButton');
            
            const startDateValue = startDateInput.value;
            const endDateValue = endDateInput.value;
            
            // Validate
            if (!startDateValue || !endDateValue) {
                showFeedback('datesFeedback', 'error', 'Validation Error', 'Start and end dates are required.');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            
            if (endDate <= startDate) {
                showFeedback('datesFeedback', 'error', 'Validation Error', 'End date must be after start date.');
                return;
            }
            
            if (!isDateInFuture(startDate, 5)) {
                showFeedback('datesFeedback', 'error', 'Validation Error', 'Start date must be at least 5 minutes in the future.');
                return;
            }
            
            if (!isDateInFuture(endDate, 5)) {
                showFeedback('datesFeedback', 'error', 'Validation Error', 'End date must be at least 5 minutes in the future.');
                return;
            }
            
            // Convert to Unix timestamps (seconds)
            const startTimestamp = Math.floor(startDate.getTime() / 1000);
            const endTimestamp = Math.floor(endDate.getTime() / 1000);
            
            // Debug log the timestamps
            debugLog(`Setting voting period with timestamps: start=${startTimestamp} (${new Date(startTimestamp * 1000).toLocaleString()}), end=${endTimestamp} (${new Date(endTimestamp * 1000).toLocaleString()})`);
            
            // Show loading state
            setButton.innerHTML = '<div class="loader"></div> Setting...';
            setButton.disabled = true;
            
            try {
                // Set voting period in the contract
                await votingContract.methods.setVotingPeriod(startTimestamp, endTimestamp).send({ from: accounts[0] });
                
                // Show success feedback
                showFeedback('datesFeedback', 'success', 'Voting Period Set', 'The voting period has been set successfully.');
                
                // Update global variables
                votingStartTime = startTimestamp;
                votingEndTime = endTimestamp;
                
                // Update UI
                updateVotingPeriodUI();
                loadVotingStats();
                
                debugLog(`Voting period set: ${startDate.toLocaleString()} to ${endDate.toLocaleString()}`);
            } catch (error) {
                console.error('Error setting voting period:', error);
                
                // Extract more specific error message if available
                let errorMessage = error.message || 'Unknown error occurred';
                
                // Check for common MetaMask errors
                if (error.code === 4001) {
                    errorMessage = 'Transaction was rejected by the user';
                } else if (error.message && error.message.includes('Internal JSON-RPC error')) {
                    // Try to extract the actual error from the RPC error
                    const match = error.message.match(/reverted with reason string '(.+?)'/);
                    if (match && match[1]) {
                        errorMessage = match[1];
                    } else if (error.message.includes('execution reverted')) {
                        errorMessage = 'Transaction reverted by the contract. Ensure dates are in the future.';
                    }
                }
                
                debugLog('Error setting voting period: ' + errorMessage);
                showFeedback('datesFeedback', 'error', 'Transaction Failed', errorMessage);
            } finally {
                // Reset button
                setButton.innerHTML = '<span class="icon-save mr-2"></span>Set New Period';
                setButton.disabled = false;
            }
        }
        
        // Handle updating existing voting dates
        async function handleUpdateDates() {
            if (!isAdmin) {
                showFeedback('datesFeedback', 'error', 'Permission Denied', 'Only the admin can update voting dates.');
                return;
            }
            
            // If no existing dates
            if (votingStartTime === 0 && votingEndTime === 0) {
                showFeedback('datesFeedback', 'warning', 'No Dates Set', 'There are no existing dates to update. Please set new dates.');
                return;
            }
            
            // Fill the form with existing dates
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            const startDate = new Date(votingStartTime * 1000);
            const endDate = new Date(votingEndTime * 1000);
            
            // Format for datetime-local input
            const formatDateForInput = (date) => {
                return date.toISOString().slice(0, 16);
            };
            
            startDateInput.value = formatDateForInput(startDate);
            endDateInput.value = formatDateForInput(endDate);
            
            showFeedback('datesFeedback', 'info', 'Update Ready', 'Existing dates have been loaded. Make your changes and click "Set New Period" to update.');
        }
        
        // Export results to CSV
        function exportResults() {
            if (candidatesData.length === 0) {
                showFeedback('candidateFeedback', 'warning', 'No Data', 'There are no results to export.');
                return;
            }
            
            // Calculate total votes
            const totalVotes = candidatesData.reduce((sum, candidate) => sum + parseInt(candidate.voteCount), 0);
            
            // Prepare CSV content
            let csvContent = 'ID,Name,Party,Votes,Percentage\n';
            
            candidatesData.forEach(candidate => {
                const percentage = totalVotes > 0 ? ((parseInt(candidate.voteCount) / totalVotes) * 100).toFixed(2) : '0.00';
                csvContent += `${candidate.id},"${candidate.name}","${candidate.party}",${candidate.voteCount},${percentage}%\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `election_results_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            debugLog('Results exported to CSV');
        }
        
        // ==========================================
        // Initialization - Add this to the end of your file
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Admin Dashboard Initialized');
            
            // Make debug panel visible with Ctrl+Shift+D hotkey
            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.shiftKey && event.key === 'D') {
                    const debugPanel = document.getElementById('debugPanel');
                    debugPanel.classList.toggle('hidden');
                }
            });
        });
        
        // Function to toggle between light and dark theme
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Settings Management Functions
        async function loadSettings() {
            try {
                if (!await isContractInitialized()) {
                    throw new Error('Contract not initialized or not accessible');
                }
                
                // Check admin status
                const adminAddress = await votingContract.methods.admin().call();
                const currentAccount = window.ethereum.selectedAddress;
                const isAdmin = adminAddress.toLowerCase() === currentAccount.toLowerCase();
                
                // Update admin status UI
                const adminStatus = document.getElementById('adminStatus');
                if (adminStatus) {
                    if (isAdmin) {
                        adminStatus.classList.add('bg-green-50', 'dark:bg-green-900');
                        const statusText = adminStatus.querySelector('p');
                        if (statusText) {
                            statusText.textContent = 'You are the admin of this contract. All functions are enabled.';
                            statusText.classList.add('text-green-800', 'dark:text-green-200');
                        }
                    } else {
                        adminStatus.classList.add('bg-yellow-50', 'dark:bg-yellow-900');
                        const statusText = adminStatus.querySelector('p');
                        if (statusText) {
                            statusText.textContent = 'You are not the admin of this contract. Some functions will be disabled.';
                            statusText.classList.add('text-yellow-800', 'dark:text-yellow-200');
                        }
                    }
                }
                
                // Get voting period from contract
                const result = await votingContract.methods.getVotingPeriod().call();
                
                // Handle the return value - it might be an object with properties or an array
                let startTime, endTime;
                
                if (typeof result === 'object') {
                    // If it's an object with properties
                    if ('startTime' in result && 'endTime' in result) {
                        startTime = result.startTime;
                        endTime = result.endTime;
                    } 
                    // If it's an array-like object
                    else if (Array.isArray(result) || (typeof result[0] !== 'undefined' && typeof result[1] !== 'undefined')) {
                        startTime = result[0];
                        endTime = result[1];
                    } else {
                        throw new Error('Invalid voting period data format');
                    }
                } else {
                    throw new Error('Invalid voting period data format');
                }
                
                // Convert to numbers and validate
                startTime = Number(startTime);
                endTime = Number(endTime);
                
                if (isNaN(startTime) || isNaN(endTime)) {
                    throw new Error('Invalid voting period values');
                }
                
                // Update UI elements with proper null checks
                const startTimeElement = document.getElementById('votingStartTime');
                const endTimeElement = document.getElementById('votingEndTime');
                const defaultImageUrlElement = document.getElementById('defaultImageUrl');
                const debugModeElement = document.getElementById('debugMode');
                
                if (startTimeElement) {
                    startTimeElement.value = new Date(startTime * 1000).toISOString().slice(0, 16);
                }
                
                if (endTimeElement) {
                    endTimeElement.value = new Date(endTime * 1000).toISOString().slice(0, 16);
                }
                
                if (defaultImageUrlElement) {
                    defaultImageUrlElement.value = appConfig.defaultImageUrl || '';
                }
                
                if (debugModeElement) {
                    debugModeElement.checked = localStorage.getItem('debugMode') === 'true';
                }
                
                debugLog('Settings loaded successfully');
            } catch (error) {
                console.error('Error loading settings:', error);
                debugLog('Error loading settings: ' + error.message);
                showFeedback('settingsFeedback', 'error', 'Error Loading Settings', error.message);
            }
        }

        // Handle voting period form submission
        document.getElementById('votingPeriodForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const startTime = Math.floor(new Date(document.getElementById('votingStartTime').value).getTime() / 1000);
                const endTime = Math.floor(new Date(document.getElementById('votingEndTime').value).getTime() / 1000);
                
                // Validate times
                const currentTime = Math.floor(Date.now() / 1000);
                if (startTime <= currentTime) {
                    throw new Error('Start time must be in the future');
                }
                if (endTime <= startTime) {
                    throw new Error('End time must be after start time');
                }
                
                // Call smart contract
                await votingContract.methods.setVotingPeriod(startTime, endTime).send({ from: accounts[0] });
                
                showFeedback('settingsFeedback', 'success', 'Success', 'Voting period updated successfully');
                debugLog('Voting period updated successfully');
            } catch (error) {
                console.error('Error updating voting period:', error);
                debugLog('Error updating voting period: ' + error.message);
                showFeedback('settingsFeedback', 'error', 'Error', error.message);
            }
        });

        // Handle system settings form submission
        document.getElementById('systemSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const newDefaultImageUrl = document.getElementById('defaultImageUrl').value;
                const debugMode = document.getElementById('debugMode').checked;
                
                // Validate URL
                try {
                    new URL(newDefaultImageUrl);
                } catch (error) {
                    throw new Error('Invalid URL format for default image');
                }
                
                // Update configuration
                appConfig.defaultImageUrl = newDefaultImageUrl;
                localStorage.setItem('debugMode', debugMode);
                
                showFeedback('settingsFeedback', 'success', 'Success', 'System settings updated successfully');
                debugLog('System settings updated successfully');
            } catch (error) {
                console.error('Error updating system settings:', error);
                debugLog('Error updating system settings: ' + error.message);
                showFeedback('settingsFeedback', 'error', 'Error', error.message);
            }
        });

        // Add settings tab to the initialization
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing initialization code ...
            
            // Add settings tab click handler
            const settingsTab = document.querySelector('[aria-controls="content-settings"]');
            if (settingsTab) {
                settingsTab.addEventListener('click', loadSettings);
            }
        });

        // Add this function to check contract initialization
        async function isContractInitialized() {
            try {
                // Check if web3 is available
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('Web3 provider not found. Please install MetaMask or another Web3 wallet.');
                }
                
                // Check if contract address is set
                if (!votingContract || !votingContract.options || !votingContract.options.address) {
                    throw new Error('Contract address not set. Please connect to the correct network.');
                }
                
                // Try to call a simple contract method to verify it's accessible
                await votingContract.methods.admin().call();
                
                return true;
            } catch (error) {
                console.error('Contract initialization check failed:', error);
                return false;
            }
        }

        // Modify the loadCandidates function
        async function loadCandidates() {
            try {
                if (!await isContractInitialized()) {
                    throw new Error('Contract not initialized or not accessible');
                }
                
                const candidates = await votingContract.methods.getAllCandidates().call();
                const candidatesList = document.getElementById('candidatesList');
                const candidatesTable = document.getElementById('candidatesTable');
                
                if (candidatesList) {
                    candidatesList.innerHTML = '';
                    candidates.forEach(candidate => {
                        // ... existing candidate rendering code ...
                    });
                }
                
                if (candidatesTable) {
                    const tbody = candidatesTable.querySelector('tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        candidates.forEach(candidate => {
                            // ... existing table rendering code ...
                        });
                    }
                }
                
                debugLog('Candidates loaded successfully');
            } catch (error) {
                console.error('Error loading candidates:', error);
                debugLog('Error loading candidates: ' + error.message);
                showFeedback('candidateFeedback', 'error', 'Error Loading Candidates', error.message);
            }
        }

        // Modify the loadVotingPeriod function
        async function loadVotingPeriod() {
            try {
                if (!await isContractInitialized()) {
                    throw new Error('Contract not initialized or not accessible');
                }
                
                // Get voting period from contract
                const result = await votingContract.methods.getVotingPeriod().call();
                
                // Handle the return value - it might be an object with properties or an array
                let startTime, endTime;
                
                if (typeof result === 'object') {
                    // If it's an object with properties
                    if ('startTime' in result && 'endTime' in result) {
                        startTime = result.startTime;
                        endTime = result.endTime;
                    } 
                    // If it's an array-like object
                    else if (Array.isArray(result) || (typeof result[0] !== 'undefined' && typeof result[1] !== 'undefined')) {
                        startTime = result[0];
                        endTime = result[1];
                    } else {
                        throw new Error('Invalid voting period data format');
                    }
                } else {
                    throw new Error('Invalid voting period data format');
                }
                
                // Convert to numbers and validate
                startTime = Number(startTime);
                endTime = Number(endTime);
                
                if (isNaN(startTime) || isNaN(endTime)) {
                    throw new Error('Invalid voting period values');
                }
                
                votingStartTime = startTime;
                votingEndTime = endTime;
                
                updateVotingPeriodUI();
                debugLog('Voting period loaded successfully');
            } catch (error) {
                console.error('Error loading voting period:', error);
                debugLog('Error loading voting period: ' + error.message);
                showFeedback('datesFeedback', 'error', 'Error Loading Voting Period', error.message);
            }
        }

        async function setVotingPeriod() {
            try {
                if (!await isContractInitialized()) {
                    throw new Error('Contract not initialized or not accessible');
                }
                
                // Get input values
                const startTimeInput = document.getElementById('votingStartTime');
                const endTimeInput = document.getElementById('votingEndTime');
                
                if (!startTimeInput || !endTimeInput) {
                    throw new Error('Voting period input elements not found');
                }
                
                // Parse input values
                const startDate = new Date(startTimeInput.value);
                const endDate = new Date(endTimeInput.value);
                
                // Validate dates
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    throw new Error('Invalid date format');
                }
                
                // Convert to Unix timestamps (seconds)
                const startTime = Math.floor(startDate.getTime() / 1000);
                const endTime = Math.floor(endDate.getTime() / 1000);
                
                // Validate timestamps
                const now = Math.floor(Date.now() / 1000);
                if (startTime <= now) {
                    throw new Error('Start time must be in the future');
                }
                
                if (startTime >= endTime) {
                    throw new Error('Start time must be earlier than end time');
                }
                
                if (endTime <= now) {
                    throw new Error('End time must be in the future');
                }
                
                // Show loading state
                const submitButton = document.getElementById('setVotingPeriodButton');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="loader"></span> Setting...';
                }
                
                // Call contract method
                await votingContract.methods.setVotingPeriod(startTime, endTime).send({ from: window.ethereum.selectedAddress });
                
                // Update UI
                votingStartTime = startTime;
                votingEndTime = endTime;
                updateVotingPeriodUI();
                
                // Show success message
                showFeedback('datesFeedback', 'success', 'Voting Period Updated', 'The voting period has been successfully updated.');
                
                // Reset button state
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Set Voting Period';
                }
            } catch (error) {
                console.error('Error setting voting period:', error);
                debugLog('Error setting voting period: ' + error.message);
                
                // Show error message
                showFeedback('datesFeedback', 'error', 'Error Setting Voting Period', error.message);
                
                // Reset button state
                const submitButton = document.getElementById('setVotingPeriodButton');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Set Voting Period';
                }
            }
        }
    </script>

    <!-- Edit Candidate Modal -->
    <div id="editCandidateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Edit Candidate</h3>
                <button type="button" onclick="closeEditCandidateModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="icon-close"></span>
                </button>
            </div>
            
            <div class="p-6">
                <div id="editCandidateFeedbackContainer" class="mb-4 p-4 rounded-md hidden">
                    <div class="flex">
                        <div id="editCandidateFeedbackIcon" class="flex-shrink-0 mr-3">
                            <!-- Icon will be added by JavaScript -->
                        </div>
                        <div>
                            <h3 id="editCandidateFeedbackTitle" class="text-sm font-medium"></h3>
                            <div class="mt-1 text-sm" id="editCandidateFeedback"></div>
                        </div>
                    </div>
                </div>

                <form id="editCandidateForm" class="space-y-4" data-admin-only="true">
                    <input type="hidden" id="editCandidateId" name="editCandidateId" autocomplete="off">
                    <div>
                        <label for="editName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Candidate Name
                        </label>
                        <input type="text" id="editName" name="editName"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            placeholder="Enter candidate name" autocomplete="name">
                    </div>
                    <div>
                        <label for="editParty" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Political Party
                        </label>
                        <input type="text" id="editParty" name="editParty"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            placeholder="Enter political party" autocomplete="organization">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Candidate Image
                        </label>
                        <div id="editImageDropArea" class="mt-1 relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 flex flex-col items-center justify-center hover:border-primary-500 dark:hover:border-primary-500 transition-colors cursor-pointer">
                            <div id="editImagePreviewContainer" class="hidden mb-3 relative">
                                <img id="editImagePreview" class="h-24 w-24 object-cover rounded-lg shadow-sm" src="" alt="Candidate preview">
                                <button type="button" id="editRemoveImageBtn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors">
                                    ‚úï
                                </button>
                            </div>
                            <div id="editUploadIconContainer">
                                <span class="mb-2 block text-3xl text-gray-400 dark:text-gray-500">üì∑</span>
                                <span class="text-gray-600 dark:text-gray-400">Drag image here or click to upload</span>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">PNG, JPG, or JPEG up to 2MB</p>
                            </div>
                            <input type="file" id="editImageUpload" name="editImageUpload" accept="image/png, image/jpeg, image/jpg" class="sr-only">
                            <input type="hidden" id="editImageUrl" name="editImageUrl">
                        </div>
                    </div>
                    <div class="pt-2">
                        <button type="submit" id="updateCandidateButton"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-primary-700 dark:hover:bg-primary-800">
                            <span class="icon-save mr-2"></span>Update Candidate
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Function to open the edit candidate modal -->
    <script>
        function openEditCandidateModal(id, name, party, imageUrl) {
            // Set the form values
            document.getElementById('editCandidateId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editParty').value = party;
            document.getElementById('editImageUrl').value = imageUrl === appConfig.defaultImageUrl ? '' : imageUrl;
            
            // Update image preview if available
            if (imageUrl && imageUrl !== appConfig.defaultImageUrl) {
                const previewImg = document.getElementById('editImagePreview');
                const previewContainer = document.getElementById('editImagePreviewContainer');
                const uploadIconContainer = document.getElementById('editUploadIconContainer');
                
                if (previewImg && previewContainer && uploadIconContainer) {
                    previewImg.src = imageUrl;
                    previewContainer.classList.remove('hidden');
                    uploadIconContainer.classList.add('hidden');
                }
            }
            
            // Clear any previous feedback
            document.getElementById('editCandidateFeedbackContainer').classList.add('hidden');
            
            // Show the modal
            document.getElementById('editCandidateModal').classList.remove('hidden');
        }

        // Function to close the edit candidate modal
        function closeEditCandidateModal() {
            document.getElementById('editCandidateModal').classList.add('hidden');
        }

        // Function to handle edit candidate form submission
        async function handleEditCandidate(event) {
            event.preventDefault();
            
            // Get form values
            const id = document.getElementById('editCandidateId').value;
            const name = document.getElementById('editName').value.trim();
            const party = document.getElementById('editParty').value.trim();
            const imageUrl = document.getElementById('editImageUrl').value.trim() || appConfig.defaultImageUrl;
            
            // Validate form
            if (!validateCandidateForm(name, party)) {
                showEditCandidateFeedback("Please fill in all required fields", "Validation Error", true);
                return;
            }
            
            // Show loading state
            const updateButton = document.getElementById('updateCandidateButton');
            updateButton.disabled = true;
            updateButton.innerHTML = '<span class="loader"></span><span>Updating...</span>';
            
            try {
                // Check if contract is connected
                if (!contractConnected) {
                    throw new Error("Blockchain not connected. Please connect your wallet first.");
                }
                
                // Update candidate in the contract
                // Note: This is a mock implementation since most contracts don't support editing candidates
                // In a real implementation, you would need to call a contract method to update the candidate
                
                // For demonstration purposes, we'll just show a success message
                showEditCandidateFeedback(`Candidate ${name} updated successfully`, "Update Successful", false);
                
                // Refresh the candidate list
                await loadCandidates();
                
                // Close the modal after a delay
                setTimeout(() => {
                    closeEditCandidateModal();
                }, 2000);
            } catch (error) {
                console.error("Error updating candidate:", error);
                showEditCandidateFeedback(error.message, "Update Failed", true);
            } finally {
                // Reset button state
                updateButton.disabled = false;
                updateButton.innerHTML = '<span class="icon-save mr-2"></span>Update Candidate';
            }
        }

        // Function to show feedback in the edit candidate modal
        function showEditCandidateFeedback(message, title = "", isError = false) {
            const feedbackContainer = document.getElementById('editCandidateFeedbackContainer');
            const feedbackIcon = document.getElementById('editCandidateFeedbackIcon');
            const feedbackTitle = document.getElementById('editCandidateFeedbackTitle');
            const feedback = document.getElementById('editCandidateFeedback');
            
            feedbackContainer.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'dark:bg-green-900/20', 'dark:bg-red-900/20', 'border-green-200', 'border-red-200', 'dark:border-green-900', 'dark:border-red-900');
            
            if (isError) {
                feedbackContainer.classList.add('bg-red-50', 'dark:bg-red-900/20', 'border', 'border-red-200', 'dark:border-red-900');
                feedbackIcon.innerHTML = '<span class="icon-exclamation-circle text-red-500 mt-0.5"></span>';
                feedbackTitle.textContent = title || "Error";
                feedbackTitle.className = "font-medium text-red-800 dark:text-red-300";
                feedback.className = "text-sm text-red-700 dark:text-red-200";
            } else {
                feedbackContainer.classList.add('bg-green-50', 'dark:bg-green-900/20', 'border', 'border-green-200', 'dark:border-green-900');
                feedbackIcon.innerHTML = '<span class="icon-check-circle text-green-500 mt-0.5"></span>';
                feedbackTitle.textContent = title || "Success";
                feedbackTitle.className = "font-medium text-green-800 dark:text-green-300";
                feedback.className = "text-sm text-green-700 dark:text-green-200";
            }
            
            feedback.textContent = message;
            feedbackContainer.classList.remove('hidden');
        }
    </script>

    <!-- Image Upload Scripts -->
    <script>
        // Initialize the drag and drop functionality for image uploads
        document.addEventListener('DOMContentLoaded', function() {
            initImageUpload('imageDropArea', 'imageUpload', 'imagePreview', 'imagePreviewContainer', 'uploadIconContainer', 'removeImageBtn', 'imageUrl');
            
            // Also initialize for the edit modal with different IDs
            initImageUpload('editImageDropArea', 'editImageUpload', 'editImagePreview', 'editImagePreviewContainer', 'editUploadIconContainer', 'editRemoveImageBtn', 'editImageUrl');
        });
        
        function initImageUpload(dropAreaId, fileInputId, previewImgId, previewContainerId, uploadIconContainerId, removeBtnId, hiddenInputId) {
            const dropArea = document.getElementById(dropAreaId);
            const fileInput = document.getElementById(fileInputId);
            const previewImg = document.getElementById(previewImgId);
            const previewContainer = document.getElementById(previewContainerId);
            const uploadIconContainer = document.getElementById(uploadIconContainerId);
            const removeBtn = document.getElementById(removeBtnId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            if (!dropArea || !fileInput || !previewImg || !previewContainer || !uploadIconContainer || !removeBtn || !hiddenInput) {
                return; // Skip initialization if any element is missing
            }
            
            // Handle click on drop area
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Handle file selection
            fileInput.addEventListener('change', handleFileSelect);
            
            // Handle drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            // Handle remove button click
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering dropArea click
                removeImage();
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                dropArea.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
            }
            
            function unhighlight() {
                dropArea.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    handleFiles(files);
                }
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length) {
                    handleFiles(files);
                }
            }
            
            function handleFiles(files) {
                const file = files[0]; // We only handle one file
                
                // Validate file type and size
                if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/jpg')) {
                    alert('Please upload a valid image file (PNG, JPG or JPEG)');
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    alert('File size exceeds 2MB limit');
                    return;
                }
                
                // Convert to base64 and display preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Set preview image
                    previewImg.src = e.target.result;
                    
                    // Store base64 in hidden input for form submission
                    hiddenInput.value = e.target.result;
                    
                    // Show preview, hide upload icon
                    previewContainer.classList.remove('hidden');
                    uploadIconContainer.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            function removeImage() {
                // Clear input and preview
                fileInput.value = '';
                hiddenInput.value = '';
                previewImg.src = '';
                
                // Hide preview, show upload icon
                previewContainer.classList.add('hidden');
                uploadIconContainer.classList.remove('hidden');
            }
        }
    </script>

    <!-- Admin JavaScript -->
    <script type="module" src="../js/admin.js"></script>
</body>
</html>
